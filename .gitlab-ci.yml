# This file is a template, and might need editing before it works on your project.
# Full project: https://gitlab.com/pages/middleman
image: registry.gitlab.com/inem/railshurts
# registry.gitlab.com/inem/inem.at:middleman
#

cache:
  untracked: true

stages:
  - generate
  - post-generate

generate:
  stage: generate
  script:
  - bundle install --path vendor
  - bundle exec middleman build
  artifacts:
    paths:
      - build
      - vendor
      - .bundle

deploy:
  stage: post-generate
  script:
  - bundle install --path vendor
  - bundle exec s3_website push
  only:
  - master

pages:
  image: alpine
  stage: post-generate
  script:
  - mv build public
  except:
  - master
  artifacts:
    paths:
    - public

write-good:
  image: node
  stage: post-generate
  script:
    - npm install -g write-good
    - write-good ./source/*.md.erb
    - write-good ./source/*.html.haml
  allow_failure: true

check-links:
  stage: post-generate
  script:
  - bundle install --path vendor
  - awesome_bot s3_website.yml build/*.html --allow-redirect --allow-dupe
  allow_failure: true